base_config: "pipeline_config.yaml"

experiments:
  - id: "A_base"
    desc: "Baseline con HPO mejorado y regularización anti-overfitting - GSC vs Meta (X,S,T)"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        top_k_donors: 20
        donor_kind: "same_item"
        lags_days: [7, 14, 28, 56]
        fourier_k: 3
        use_stl: true
        gsc_rank: 3                      # Reducido de 5 a 3 (menor capacidad)
        gsc_tau: 0.01                    # Aumentado de 0.0001 a 0.01 (100x más regularización)
        gsc_alpha: 0.005                 # Aumentado de 0.0 a 0.005
        meta_learners: ["x", "s", "t"]  # Todos los learners para comparación
        treat_col_s: "H_disc"
        h_bin_threshold: 0.02
        gsc_cv_folds: 5                  # Aumentado de 3 a 5 (más validación)
        gsc_cv_holdout: 14               # Reducido de 21 a 14 (ventanas más pequeñas para rolling CV)
        gsc_cv_gap: 7                    # Gap de 7 días para evitar filtración
        gsc_hpo_trials: 300              # Optuna trials para GSC
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "B_donors30"
    desc: "Más donantes para mejor ajuste GSC"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        top_k_donors: 30
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "C_donors5_hiqual"
    desc: "Pocos donantes de alta calidad"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        top_k_donors: 5
        max_donor_promo_share: 0.01
        min_availability_share: 0.95
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "D_seasonal_rich"
    desc: "Estacionalidad enriquecida"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        fourier_k: 6
        lags_days: [7, 14, 28, 56, 84]
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "E_no_stl"
    desc: "Sin descomposición STL"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        use_stl: false
        fourier_k: 6
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "F_treat_continuous"
    desc: "Tratamiento continuo (H_prop) para Meta"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        meta_learners: ["x", "s", "t"]
        treat_col_s: "H_prop"  # Tratamiento continuo
        treat_col_b: "H_prop"
        bin_threshold: 0.0
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "G_cv_robust"
    desc: "CV más robusto con rolling window (7 folds, 14 días holdout, gap 7)"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        gsc_cv_folds: 7                  # Más folds para rolling CV
        gsc_cv_holdout: 14               # Ventanas más pequeñas
        gsc_cv_gap: 7                    # Gap de 7 días
        gsc_rank: 3
        gsc_tau: 0.01
        gsc_alpha: 0.005
        meta_cv_folds: 7
        meta_cv_holdout: 14
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "H_gsc_regularized"
    desc: "GSC con ALTA regularización para evitar overfitting"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
      params:
        gsc_rank: 2                      # Rank bajo (alta regularización)
        gsc_tau: 0.05                    # Tau alto (alta regularización nuclear)
        gsc_alpha: 0.01                  # Alpha alto (alta regularización L2)
        gsc_cv_folds: 5
        gsc_cv_holdout: 14
        gsc_cv_gap: 7
        meta_learners: ["x", "s", "t"]
        meta_hpo_trials: 100
        meta_max_iter: 1000
        eda_alg_max_episodes_gsc: 30
        eda_alg_max_episodes_meta: 30

  - id: "A_quick_smoke2"
    desc: "Smoke test: 5 episodios, 5 donantes, HPO Meta=3 trials"
    overrides:
      toggles:
        step1: true
        step2: true
        step3: true
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: true
        use_available_A_feature: false
        use_zero_streak_feature: false
        meta_learners: [x, t, s]
        meta_min_train_samples: 100

  - id: "FINAL_PAPERv2"
    desc: "Experimento definitivo para paper final: 50 víctimas, X/S/T learners, 15-20 donantes, 500 trials GSC, 200 trials Meta"
    overrides:
      toggles:
        step1: true                     # Reutilizar datos procesados compartidos
        step2: true                    # Reutilizar competitive_exposure compartido
        step3: true                    # Reutilizar pairs y donors compartidos
        step4: true                     # Preparar features
        step5_gsc: true                 # Ejecutar GSC con HPO
        step6_meta: true                # Ejecutar Meta-learners con HPO
        eda_algorithms: true            # Generar gráficas finales
        use_cached_step1: true
        use_cached_step2: true
        use_cached_step3: true
      params:
        # ===== SELECCIÓN DE EPISODIOS =====
        n_cannibals: 10                 # 10 caníbales
        n_victims_per_cannibal: 5       # 5 víctimas por caníbal = 50 víctimas totales
        
        # ===== DONANTES =====
        top_k_donors: 12                # 15-20 donantes por víctima (18 es punto medio)
               # Donantes del mismo producto
        max_donor_promo_share: 0.20     # Máximo 2% de días en promoción
        min_availability_share: 0.80    # Mínimo 90% de disponibilidad
        
        # ===== FEATURES =====
        lags_days: [7, 14, 28, 56]      # Lags semanales, quincenales, mensuales, bimestrales
        fourier_k: 3                    # Componentes de Fourier para estacionalidad
        use_stl: true                   # Descomposición STL (trend + seasonal)
        
        # ===== GSC: CONTROL SINTÉTICO GENERALIZADO =====
                          # Rank bajo para evitar overfitting
                         # Regularización nuclear (100x más que baseline)
                     # Regularización L2
        gsc_hpo_trials: 500             # 500 trials de Optuna para HPO
        gsc_cv_folds: 8                # 5 folds de validación cruzada rolling
        gsc_cv_holdout: 21             # Ventanas de 14 días
        gsc_cv_gap: 14                   # Gap de 7 días entre train/test
        gsc_train_gap: 14              # Embargo de 7 días antes del tratamiento
        gsc_include_covariates: false    # Incluir covariables en el modelo
        gsc_link: "log1p"               # Transformación log1p para estabilizar varianza
        gsc_calibrate_victim: "level"   # Calibrar nivel del contrafactual
        gsc_post_smooth_window: 1       # Sin suavizado post-predicción
        gsc_pred_clip_min: 0.0          # Clip predicciones negativas a 0
            # Tests placebo espaciales
              # Tests placebo temporales
                   # Sin leave-one-o           # Sin análisis de sensibilidad adicional
        gsc_max_episodes: null          # Procesar TODOS los episodios (50)
        
        # ===== META-LEARNERS: X, S, T =====
        meta_learners: ["s"]  # Los 3 meta-learners principales
        meta_model: "hgbt"              # Histogram Gradient Boosting Trees
        meta_prop_model: "logit"        # Logistic regression para propensity score
        meta_hpo_trials: 1           # 200 trials de Optuna por learner
        meta_max_iter: 1000             # Máximo 1000 iteraciones de boosting
        meta_max_depth: 6               # Profundidad máxima de árboles
        meta_learning_rate: 0.05        # Learning rate conservador
        meta_min_samples_leaf: 20       # Mínimo 20 muestras por hoja
        meta_l2: 0.0                    # Sin regularización L2 adicional (HGBT ya tiene)
        meta_cv_folds: 5                # 5 folds de validación cruzada
        meta_cv_holdout: 14             # Ventanas de 14 días
        meta_min_train_samples: 50      # Mínimo 50 muestras para entrenar
        meta_random_state: 42           # Seed para reproducibilidad
        meta_max_episodes: null         # Procesar TODOS los episodios (50)
        meta_do_placebo_space: true     # Tests placebo espaciales
        meta_do_placebo_time: true      # Tests placebo temporales
        meta_do_loo: false              # Sin leave-one-out
        meta_max_loo: 5
        meta_sens_samples: 0            # Sin análisis de sensibilidad adicional
        
        # ===== TRATAMIENTO =====
        treat_col_s: "H_disc"           # Tratamiento discretizado (0/1)
        s_ref: 0.0                      # Valor de referencia para S-learner
        treat_col_b: "H_prop"           # Tratamiento continuo (proporción)
        bin_threshold: 0.0              # Umbral para binarización
        h_bin_threshold: 0.02           # Umbral para considerar alta exposición
        
        # ===== EDA FINAL =====
        eda_alg_orientation: "landscape"    # Orientación horizontal para gráficas
        eda_alg_dpi: 300                    # Alta resolución para publicación
        eda_alg_learners: ["t", "s", "x"]   # Comparar los 3 learners
        eda_alg_export_pdf: true            # Exportar PDFs además de PNGs
        eda_alg_max_episodes_gsc: 50        # Plotear las 50 víctimas para GSC
        eda_alg_max_episodes_meta: 50       # Plotear las 50 víctimas para cada Meta-learner

  - id: "M1_meta_x_baseline"
    desc: "Meta-X baseline (LGBM, CV=5x14, lags/fourier ricos, sin sc_hat)"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0

  - id: "M2_meta_t_baseline"
    desc: "Meta-T baseline (LGBM, misma config que M1)"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["t"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0

  - id: "M3_meta_s_baseline"
    desc: "Meta-S baseline (LGBM, misma config que M1)"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["s"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0
        s_ref: 0.0

  - id: "M4_meta_x_sc_hat_on"
    desc: "Meta-X con sc_hat habilitado"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: true
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0

  - id: "M5_meta_x_hgbt"
    desc: "Meta-X con HGBT"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: "hgbt"
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0


  - id: "M6_meta_x_hgbt"
    desc: "Meta-X con HGBT"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: "hgbt"
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0
        # meta_do_placebo_space: true
        # meta_do_placebo_time: true


  - id: "M6_meta_x_cv7"
    desc: "Meta-X CV=7x14"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 7
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0

  - id: "M7_meta_x_lags_rich"
    desc: "Meta-X con lags/fourier enriquecidos"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 100
        meta_max_iter: 1000
        lags_days: [1,2,3,4,7,14,21,28,56,84]
        fourier_k: 10
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0

  - id: "M8_meta_x_min_train_50"
    desc: "Meta-X con min_train=50"
    overrides:
      toggles:
        step1: false
        step2: false
        step3: false
        step4: true
        step5_gsc: false
        step6_meta: true
        eda_algorithms: true
      params:
        meta_model: lgbm
        meta_learners: ["x"]
        meta_hpo_trials: 50
        meta_cv_folds: 5
        meta_cv_holdout: 14
        meta_min_train_samples: 50
        meta_max_iter: 1000
        lags_days: [1,2,3,7,14,28,56]
        fourier_k: 8
        use_sc_hat_feature: false
        use_available_A_feature: false
        use_zero_streak_feature: false
        treat_col_s: "H_disc"
        treat_col_b: "H_prop"
        bin_threshold: 0.0